<!DOCTYPE html>
<html lang="hu" data-theme="lightmint">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shift Planner – Nyitvatartás szinkronizálva</title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* ===== THEME TOKENS ===== */
    :root{
      --bg: #ffffff; --fg: #111111; --muted: rgba(0,0,0,0.6);
      --card-bg: #ffffff; --card-border:#e5e7eb;
      --input-bg:#ffffff; --input-border:#d1d5db;
      --accent:#10b981; --accent-weak:#d1fae5; --table-head:#f9fafb;
      color-scheme: light;
    }
    html[data-theme="lightmint"]{
      --bg:#f7fffb; --fg:#0b1220; --muted:rgba(11,18,32,.65);
      --card-bg:#fff; --card-border:#d9efe6; --input-bg:#fff; --input-border:#cfe9de;
      --accent:#10b981; --accent-weak:#d1fae5; --table-head:#effcf6; color-scheme:light;
    }
    html[data-theme="dark"]{
      --bg:#014d40; --fg:#e7ecef; --muted:rgba(231,236,239,.7);
      --card-bg:#025f4e; --card-border:#037d65; --input-bg:#014d40; --input-border:#037d65;
      --accent:#10b981; --accent-weak:#046c54; --table-head:#025f4e; color-scheme:dark;
    }
    html[data-theme="elegant"]{
      --bg:#025f4e; --fg:#f3f1e7; --muted:rgba(243,241,231,.7);
      --card-bg:#037d65; --card-border:#049b7d; --input-bg:#025f4e; --input-border:#049b7d;
      --accent:#d4af37; --accent-weak:#2a2413; --table-head:#037d65; color-scheme:dark;
    }

    /* ===== RESET & BASE ===== */
    *{box-sizing:border-box}
    body{margin:0;font-family:'Raleway', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; background:var(--bg); color:var(--fg)}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    .card{border:1px solid var(--card-border);border-radius:16px;padding:16px;background:var(--card-bg);margin-bottom:16px;transition:background .2s,border-color .2s}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    label{font-size:12px;opacity:.85;color:var(--muted)}
    input,select,button{padding:8px;border:1px solid var(--input-border);border-radius:8px;background:var(--input-bg);color:var(--fg)}
    button{cursor:pointer;background:var(--accent);color:#fff;border:none;font-weight:700}
    button:hover{filter:brightness(1.08)}
    button:active{transform:scale(.98)}
    button:disabled{opacity:.55;cursor:not-allowed}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--card-border);padding:.5rem;text-align:center}
    thead tr{background:var(--table-head)}
    .left{text-align:left}
    .muted{font-size:12px;color:var(--muted)}

    .tabs{display:flex;gap:8px;margin-top:8px}
    .tabbtn{padding:8px 12px;border:1px solid var(--input-border);border-radius:8px;background:var(--input-bg);cursor:pointer;color:var(--fg)}
    .tabbtn.active{background:var(--accent);color:#0b1220;border-color:transparent}
    html[data-theme="dark"] .tabbtn.active, html[data-theme="elegant"] .tabbtn.active{color:#0b0f14}

    .hidden{display:none}

    /* Heatmap legend colors */
    .c0{background:#ef4444;color:#fff}
    .c1{background:#c2410c;color:#fff}
    .c2{background:#fde047;color:#111}
    .c3{background:#22c55e;color:#fff}

    /* Theme switcher */
    .theme-switcher{position:fixed;right:16px;top:12px;z-index:9999;display:flex;gap:8px;align-items:center;background:var(--card-bg);border:1px solid var(--card-border);padding:6px 10px;border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,.08)}
    .theme-dot{width:22px;height:22px;border-radius:999px;border:2px solid #a1e6c5;display:inline-block;cursor:pointer}
    .dot-mint{background:linear-gradient(135deg,#b7f5d1,#10b981)}
    .dot-dark{background:linear-gradient(135deg,#6de3b9,#1e3a8a)}
    .dot-elegant{background:linear-gradient(135deg,#b3f5ce,#d4af37)}
    .theme-dot.is-active{box-shadow:0 0 0 2px #10b981 inset}

    /* Subtabs (Stats) */
    #statsSubtabs{gap:8px;align-items:center;margin-bottom:8px}
    .subtabBtn{border:1px solid var(--card-border);background:var(--card-bg);padding:6px 12px;border-radius:999px;cursor:pointer;font:500 13px/1.2 system-ui}
    .subtabBtn.active{background:#111;color:#fff;border-color:#111}

    /* KPI grid */
    .kpiGrid{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:12px}
    .kpi{padding:10px;border:1px solid var(--card-border);border-radius:12px;background:var(--card-bg)}
    .kpi .v{font-weight:700;font-size:18px}

    #heatmapWrap{overflow:auto}
    #heatmapTable{border-collapse:separate;border-spacing:2px;margin-top:6px}
    #heatmapTable th,#heatmapTable td{padding:6px 8px;text-align:center;border:1px solid var(--card-border);border-radius:6px;min-width:34px}

    /* Alerts */
    #alertsList{display:grid;gap:8px}
    .alertItem{padding:8px 10px;border:1px dashed #ef4444;border-radius:10px;background:#fff0f0}

    /* Open-hours table common */
    .ohTbl th,.ohTbl td{border:1px solid var(--card-border);padding:6px}
    .ohTbl input[type=time]{width:120px}
    .ohTbl input[type=checkbox]{transform:translateY(2px)}
  </style>
</head>
<body>
  <!-- Theme Switcher -->
  <div class="theme-switcher" role="group" aria-label="Téma választó">
    <span class="label muted">Téma:</span>
    <button class="theme-dot dot-mint" data-theme="lightmint" aria-label="Világos menta"></button>
    <button class="theme-dot dot-dark" data-theme="dark" aria-label="Sötét"></button>
    <button class="theme-dot dot-elegant" data-theme="elegant" aria-label="Elegáns arany"></button>
  </div>

  <div class="wrap">
    <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <h1 style="margin:0; display:flex; align-items:center; gap:12px">
        <img src="mintshift_logo.png" alt="MintShift Logo" style="height:86px"/>
        <span>Shift Planner</span>
      </h1>
      <div class="row" style="margin-left:auto">
        <button id="exportXlsxBtn">Letöltés XLSX (sablon szerint)</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" id="tabMain">Beosztás</button>
      <button class="tabbtn" id="tabAdmin">Admin</button>
      <button class="tabbtn" id="tabStats">Statisztikák</button>
    </div>

    <!-- ===== Beosztás ===== -->
    <div id="panelMain">
      <!-- NEW: Open-hours block (same as Stats) -->
      <div class="card" id="openHoursCardMain">
        <details open>
          <summary><b>Nyitvatartás beállítása (opcionálisan napokra)</b></summary>
          <div class="muted" style="margin:6px 0">Itt állítjuk be a tényleges nyitvatartást. <b>Ha a hely zárva, azt az órát nem vesszük figyelembe</b> a hőtérképnél és riasztásoknál. A színezés a nyitvatartási sávban <b>+1 óra</b> (nyitás előtt és zárás után is 1 óra).</div>
          <div id="openHoursMain"></div>
        </details>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label for="weekStart">Hét kezdete</label><br/>
            <input id="weekStart" type="date" />
          </div>
          <div>
            <label>Gyors műszak hozzáadás</label><br/>
            <select id="emp"></select>
            <select id="role"></select>
            <input id="date" type="date" />
            <input id="start" type="time" value="10:00" />
            <input id="end" type="time" value="18:00" />
            <button id="addShift">Hozzáadás</button>
          </div>
        </div>
      </div>

      <div class="card hidden">
        <h2 style="margin:0 0 8px">Munkatársak</h2>
        <div class="row">
          <input id="newEmp" placeholder="Új munkatárs neve" />
          <input id="wage" type="number" step="50" min="0" placeholder="Órabér (opcionális)" />
          <button id="addEmp">Hozzáadás</button>
        </div>
        <div id="empList" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card hidden">
        <h2 style="margin:0 0 8px">Munkakörök</h2>
        <div class="row">
          <input id="newRole" placeholder="Új munkakör" />
          <button id="addRole">Hozzáadás</button>
        </div>
        <div id="roleList" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px">Heti Beosztás</h2>
        <div style="overflow:auto">
          <table id="shiftTable">
            <thead>
              <tr>
                <th class="left">Dátum</th>
                <th class="left">Nap</th>
                <th class="left">Munkatárs</th>
                <th class="left">Munkakör</th>
                <th>Kezdés</th>
                <th>Vége</th>
                <th>Óra</th>
                <th>Törlés</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px">Létszám óránként (napokra bontva)</h2>
        <div style="overflow:auto">
          <table id="headTable">
            <thead>
              <tr><th class="left">Dátum</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:8px">
          <b>Színek:</b>
          <span style="color:#ef4444">Piros</span> – nincs beosztott; 
          <span style="color:#c2410c">sötét narancs</span> – kevés beosztott; 
          <span style="color:#a16207">sárga</span> – felülvizsgálandó; 
          <span style="color:#16a34a">zöld</span> – megfelelő. A táblázat 09:00-tól 08:00-ig megy, és csak a napi nyitvatartási sávban színezünk (+1 óra előtte/utána).
        </div>
      </div>
    </div>

    <!-- ===== Admin ===== -->
    <div id="panelAdmin" class="hidden">
      <div class="card">
        <h2 style="margin:0 0 8px">Munkatársak kezelése</h2>
        <div class="row">
          <input id="adminNewEmp" placeholder="Új munkatárs neve" />
          <input id="adminWage" type="number" step="50" min="0" placeholder="Órabér (opcionális)" />
          <button id="adminAddEmp">Hozzáadás</button>
        </div>
        <div class="row" style="gap:8px;margin:8px 0">
          <button id="empEditBtn">Szerkesztés</button>
          <button id="empSaveBtn" class="hidden">Mentés</button>
          <button id="empCancelBtn" class="hidden">Mégse</button>
        </div>
        <div style="overflow:auto">
          <table class="clean" id="adminEmpTable">
            <thead><tr><th>Név</th><th>Órabér (HUF)</th><th>Törlés</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px">Munkakörök kezelése</h2>
        <div class="row">
          <input id="adminNewRole" placeholder="Új munkakör" />
          <button id="adminAddRole">Hozzáadás</button>
        </div>
        <div class="row" style="gap:8px;margin:8px 0">
          <button id="roleEditBtn">Szerkesztés</button>
          <button id="roleSaveBtn" class="hidden">Mentés</button>
          <button id="roleCancelBtn" class="hidden">Mégse</button>
        </div>
        <div style="overflow:auto">
          <table class="clean" id="adminRoleTable">
            <thead><tr><th>Munkakör</th><th>Törlés</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== Statisztikák ===== -->
    <div id="panelStats" class="hidden">
      <div id="statsSubtabs" class="row">
        <button class="subtabBtn active" data-sub="overview">Áttekintés</button>
        <button class="subtabBtn" data-sub="money">Pénz &amp; teljesítmény</button>
        <label id="toggleMoneyWrap" style="margin-left:auto;align-items:center;gap:6px;font-size:12px;display:flex">
          <input type="checkbox" id="toggleMoneyFeature" />
          <span>Pénz &amp; teljesítmény engedélyezve</span>
        </label>
      </div>

      <div class="card" id="overviewKpiCard">
        <h2>Áttekintés – heti KPI-k</h2>
        <div class="row" style="align-items:flex-end">
          <label>Hét kezdete (H): <input type="week" id="statsWeek" /></label>
          <label>Cél létszám/óra (hétköznap): <input type="number" id="targetWeekday" value="0" min="0" step="1"/></label>
          <label>Cél létszám/óra (hétvége): <input type="number" id="targetWeekend" value="0" min="0" step="1"/></label>
          <label>Szünet szabály: óránként <input type="number" id="brPerHours" value="6" min="1" step="1" style="width:60px"/> óra → min. <input type="number" id="brMin" value="30" min="0" step="5" style="width:70px"/> perc</label>
          <button id="exportOverviewXlsxBtn">Export: Áttekintés XLSX</button>
        </div>
        <details style="margin-top:8px">
          <summary>Nyitvatartás beállítása (opcionálisan napokra)</summary>
          <div class="muted" style="margin:6px 0">Ugyanaz az állapot, mint a Beosztás fülön. Bárhol állítod, mindenhol frissül.</div>
          <div id="openHoursStats"></div>
        </details>

        <div class="kpiGrid" style="margin-top:8px">
          <div class="kpi"><div class="label muted">Össz. műszak</div><div class="v" id="kpiTotalShifts">—</div></div>
          <div class="kpi"><div class="label muted">Össz. munkaóra</div><div class="v" id="kpiTotalHours">—</div></div>
          <div class="kpi"><div class="label muted">Átlag műszakhossz</div><div class="v" id="kpiAvgShift">—</div></div>
          <div class="kpi"><div class="label muted">Fill rate</div><div class="v" id="kpiFillRate">—</div></div>
          <div class="kpi"><div class="label muted">Késés (50% / 90%)</div><div class="v" id="kpiLate">—</div></div>
          <div class="kpi"><div class="label muted">Pihenőidő &lt; 11h</div><div class="v" id="kpiRestViol">—</div></div>
        </div>
      </div>

      <div class="card" id="overviewHeatmapCard">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <h2 style="margin:0;">Lefedettség hőtérkép (óra × nap)</h2>
          <label style="font-size:12px;display:flex;align-items:center;gap:6px;">Induló óra:
            <select id="heatmapStartHour" style="padding:6px 8px;border-radius:8px;"></select>
          </label>
        </div>
        <div id="heatmapWrap">
          <table id="heatmapTable">
            <thead><tr id="heatmapHead"><th>Nap</th></tr></thead>
            <tbody id="heatmapBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card" id="overviewTablesCard">
        <h2>Részletek</h2>
        <h3>Per-dolgozó összefoglaló</h3>
        <table class="tbl" id="empSummaryTbl">
          <thead><tr><th>Név</th><th>Órák</th><th>Műszakok</th><th>Éjszaka órák</th><th>Hétvégi órák</th><th>Késések (db)</th></tr></thead>
          <tbody></tbody>
        </table>
        <h3 style="margin-top:10px">Riasztások</h3>
        <details id="alertsBox">
          <summary id="alertsSummary">Nincs riasztás</summary>
          <div id="alertsList"></div>
        </details>
      </div>

      <div class="card" id="moneyPerfCard">
        <h2>Pénz &amp; teljesítmény</h2>
        <div class="row" style="gap:12px;align-items:flex-end">
          <label>OT küszöb (óra/hét)<br/><input type="number" id="otThreshold" value="40" min="0" step="1"/></label>
          <label>OT szorzó<br/><input type="number" id="otMult" value="1.5" min="1" step="0.1"/></label>
          <label>Éjszakai pótlék %<br/><input type="number" id="nightPct" value="0" min="0" step="1"/></label>
          <label>Hétvégi pótlék %<br/><input type="number" id="weekendPct" value="0" min="0" step="1"/></label>
          <label>Ünnepnapi pótlék %<br/><input type="number" id="holidayPct" value="0" min="0" step="1"/></label>
          <label>Ünnepnapok (YYYY-MM-DD, ...)<br/><input type="text" id="holidayDates" placeholder="2025-08-20,2025-12-25"/></label>
          <label>Borravaló (összes HUF)<br/><input type="number" id="tipsTotal" value="" min="0" step="100"/></label>
          <label>Tip elosztás<br/>
            <select id="tipMode">
              <option value="none">Kikapcsolva</option>
              <option value="hours">Óra arányosan</option>
              <option value="equal">Egyenlően</option>
              <option value="shift">Műszakszám arányosan</option>
            </select>
          </label>
          <button id="exportStatsXlsxBtn">Export: Statisztika XLSX</button>
        </div>
        <div style="overflow:auto; margin-top:8px">
          <table class="clean" id="moneyTable">
            <thead>
              <tr>
                <th>Név</th><th>Óra össz</th><th>Alapóra</th><th>Túlóra</th><th>Alapbér</th><th>Túlóra díj</th>
                <th>Éjszakai pótlék</th><th>Hétvégi pótlék</th><th>Ünnepnapi pótlék</th><th>Tipprész</th><th>Költség</th><th>Kifizetés össz</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries for XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <script>
  // ===== THEME =====
  (function(){
    const KEY='theme_v1';
    function apply(t){ if(!t) return; document.documentElement.setAttribute('data-theme', t); document.querySelectorAll('.theme-dot').forEach(b=>b.classList.toggle('is-active', b.dataset.theme===t)); }
    const stored = localStorage.getItem(KEY)||'lightmint'; apply(stored);
    document.querySelectorAll('.theme-dot').forEach(btn=>btn.addEventListener('click', ()=>{ const t=btn.dataset.theme; localStorage.setItem(KEY,t); apply(t);}));
  })();
  </script>

  <script>
  // ===== CORE STATE & UTIL =====
  (function(){
    // --- Utilities ---
    const pad = n=>String(n).padStart(2,'0');
    const toISO = d=> d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
    const startOfWeekMon = (date=new Date())=>{ const d=new Date(date); d.setHours(0,0,0,0); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d; };
    const addDays=(d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};
    const parseTime=t=>{ if(!t) return 0; const [h,m]=t.split(':').map(Number); return h + (m||0)/60; };
    const parseHour=t=>{ if(!t) return 0; const [h]=t.split(':').map(Number); return h; };
    const hoursBetween=(a,b)=>{ let x=parseTime(a), y=parseTime(b); let d=y-x; if(d<0) d+=24; return +d.toFixed(2); };
    const overlapsHour=(a,b,h)=>{ const s=parseTime(a), e=parseTime(b); if(s===e) return false; if(e>s) return s < h+1 && e > h; return s < h+1 || e > h; };

    const DAY_KEYS=['mon','tue','wed','thu','fri','sat','sun'];
    const DAY_LABELS={mon:'Hétfő',tue:'Kedd',wed:'Szerda',thu:'Csütörtök',fri:'Péntek',sat:'Szombat',sun:'Vasárnap'};
    const HUN_NAMES=['Vasárnap','Hétfő','Kedd','Szerda','Csütörtök','Péntek','Szombat'];
    const hoursOrder=[...Array(24).keys()].slice(9).concat([...Array(24).keys()].slice(0,9)); // 09..08

    // --- Persistent state ---
    let employees=[], roles=['Bartender','Felszolgáló','Hostess'], shifts=[];
    let weekStart = toISO(startOfWeekMon(new Date()));

    // New canonical open-hours model
    // openHours_v2 = { mon:{closed:false,start:'11:00',end:'00:00'}, ... }
    function defaultOpenHours(){
      const base={closed:false,start:'11:00',end:'00:00'}; const o={}; DAY_KEYS.forEach(k=>o[k]={...base}); return o;
    }
    function loadOpenHours(){
      try{ const s=localStorage.getItem('openHours_v2'); if(s){ const o=JSON.parse(s); if(o && typeof o==='object') return o; } }catch{}
      return defaultOpenHours();
    }
    function saveOpenHours(o){ try{ localStorage.setItem('openHours_v2', JSON.stringify(o)); }catch{} }
    let openHours = loadOpenHours();

    function load(){
      try{ employees = JSON.parse(localStorage.getItem('emp_v2')||'[]')||[]; }catch{}
      try{ const r = JSON.parse(localStorage.getItem('roles_v1')||'[]'); if(Array.isArray(r)&&r.length) roles=r; }catch{}
      try{ shifts = JSON.parse(localStorage.getItem('shifts_v1')||'[]')||[]; }catch{}
      try{ const w = localStorage.getItem('weekStart_v1'); if(w) weekStart=w; }catch{}
    }
    function save(){
      try{ localStorage.setItem('emp_v2', JSON.stringify(employees)); }catch{}
      try{ localStorage.setItem('roles_v1', JSON.stringify(roles)); }catch{}
      try{ localStorage.setItem('shifts_v1', JSON.stringify(shifts)); }catch{}
      try{ localStorage.setItem('weekStart_v1', weekStart); }catch{}
      saveOpenHours(openHours);
    }

    // --- Open-hours helpers ---
    function getOpenCloseForDow(dowKey){
      const d = openHours[dowKey] || {closed:true,start:'00:00',end:'00:00'};
      if(d.closed) return null; // closed the whole day
      return {start:d.start||'00:00', end:d.end||'24:00'};
    }
    // Highlight rule: +1h before open and +1h after close
    function inHighlight(h, dowIndex){
      const map=['sun','mon','tue','wed','thu','fri','sat'];
      const key = map[dowIndex];
      const info = getOpenCloseForDow(key);
      if(!info){ return false; }
      let openH=parseHour(info.start), closeH=parseHour(info.end);
      const startH=(openH-1+24)%24, endH=(closeH+1)%24;
      if(endH>startH) return h>=startH && h<=endH;
      return h>=startH || h<=endH;
    }

    // --- DOM refs ---
    const panelMain=document.getElementById('panelMain');
    const panelAdmin=document.getElementById('panelAdmin');
    const panelStats=document.getElementById('panelStats');
    const tabMain=document.getElementById('tabMain');
    const tabAdmin=document.getElementById('tabAdmin');
    const tabStats=document.getElementById('tabStats');

    // Tabs
    function showTab(which){
      panelMain.classList.add('hidden'); panelAdmin.classList.add('hidden'); panelStats.classList.add('hidden');
      tabMain.classList.remove('active'); tabAdmin.classList.remove('active'); tabStats.classList.remove('active');
      if(which==='admin'){ panelAdmin.classList.remove('hidden'); tabAdmin.classList.add('active'); renderAdmin(); }
      else if(which==='stats'){ panelStats.classList.remove('hidden'); tabStats.classList.add('active'); renderStatsAll(); }
      else { panelMain.classList.remove('hidden'); tabMain.classList.add('active'); }
    }
    tabMain.addEventListener('click', ()=>showTab('main'));
    tabAdmin.addEventListener('click', ()=>showTab('admin'));
    tabStats.addEventListener('click', ()=>showTab('stats'));

    // Selectors (Main)
    const elWeek=document.getElementById('weekStart');
    const elEmpSel=document.getElementById('emp');
    const elRoleSel=document.getElementById('role');
    const elDate=document.getElementById('date');
    const elStart=document.getElementById('start');
    const elEnd=document.getElementById('end');
    const elShiftTBody=document.querySelector('#shiftTable tbody');
    const elHeadThead=document.querySelector('#headTable thead tr');
    const elHeadTBody=document.querySelector('#headTable tbody');

    function hunWeekdayFromISO(iso){ const d=new Date(iso+'T00:00:00'); return HUN_NAMES[d.getDay()]; }

    function renderSelectors(){
      elEmpSel.innerHTML = '<option value="">Munkatárs</option>' + employees.map(e=>`<option>${e.name}</option>`).join('');
      elRoleSel.innerHTML = '<option value="">Munkakör</option>' + roles.map(r=>`<option>${r}</option>`).join('');
    }

    function renderShiftTable(){
      const start = new Date(weekStart+'T00:00:00'); const days = Array.from({length:7},(_,i)=>addDays(start,i));
      elShiftTBody.innerHTML='';
      for(const d of days){
        const iso = toISO(d); const hunDay=hunWeekdayFromISO(iso); const dayShifts=shifts.filter(s=>s.dateISO===iso);
        if(dayShifts.length===0){
          const tr=document.createElement('tr'); tr.innerHTML=`<td class="left">${iso}</td><td class="left">${hunDay}</td><td class="left" colspan="5" style="opacity:.6">Nincs beosztás</td><td></td>`; elShiftTBody.appendChild(tr); continue;
        }
        dayShifts.forEach((s,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            ${idx===0?`<td class="left">${iso}</td><td class="left">${hunDay}</td>`:`<td></td><td></td>`}
            <td class="left">${s.employee}</td>
            <td class="left"><select data-act="role"><option value="">Munkakör</option>${roles.map(r=>`<option ${r===s.role?'selected':''}>${r}</option>`).join('')}</select></td>
            <td><input type="time" value="${s.start}" data-act="start"></td>
            <td><input type="time" value="${s.end}" data-act="end"></td>
            <td>${hoursBetween(s.start,s.end)}</td>
            <td><button data-act="del">Törlés</button></td>`;
          tr.querySelector('[data-act="role"]').addEventListener('change', e=>{ s.role=e.target.value; save(); renderAll(); });
          tr.querySelector('[data-act="start"]').addEventListener('change', e=>{ s.start=e.target.value; save(); renderAll(); });
          tr.querySelector('[data-act="end"]').addEventListener('change', e=>{ s.end=e.target.value; save(); renderAll(); });
          tr.querySelector('[data-act="del"]').addEventListener('click', ()=>{ shifts=shifts.filter(x=>x!==s); save(); renderAll(); });
          elShiftTBody.appendChild(tr);
        });
      }
    }

    function renderHeadTable(){
      elHeadThead.innerHTML = '<th class="left">Dátum</th>' + hoursOrder.map(h=>`<th>${pad(h)}:00–${pad((h+1)%24)}:00</th>`).join('');
      const start = new Date(weekStart+'T00:00:00'); const days = Array.from({length:7},(_,i)=>addDays(start,i));
      elHeadTBody.innerHTML='';
      const headByDay={}; for(const d of days) headByDay[toISO(d)] = Array.from({length:24},()=>0);
      for(const s of shifts){ if(!headByDay[s.dateISO]) continue; for(let h=0;h<24;h++) if(overlapsHour(s.start,s.end,h)) headByDay[s.dateISO][h]++; }
      for(const d of days){
        const iso=toISO(d); const dow=d.getDay();
        const tr=document.createElement('tr'); tr.appendChild(Object.assign(document.createElement('td'), {className:'left',textContent:iso,style:'font-weight:600'}));
        for(const h of hoursOrder){ const c=headByDay[iso][h]; const td=document.createElement('td'); td.textContent=c; if(inHighlight(h,dow)) td.className=(c===0?'c0':c===1?'c1':c===2?'c2':'c3'); tr.appendChild(td); }
        elHeadTBody.appendChild(tr);
      }
    }

    // ===== Open-hours UI (shared instance for Main & Stats) =====
    function renderOpenHoursInto(container){
      const wrap=document.getElementById(container);
      if(!wrap) return;
      const tbl=document.createElement('table'); tbl.className='ohTbl'; tbl.innerHTML = `
        <thead><tr><th>Nap</th><th>Nyit</th><th>Zár</th><th>Zárva</th></tr></thead>
        <tbody>
          ${DAY_KEYS.map(k=>{
            const d=openHours[k]||{closed:false,start:'11:00',end:'00:00'};
            return `<tr data-k="${k}"><td>${DAY_LABELS[k]}</td>
              <td><input type="time" value="${d.start||'00:00'}" ${d.closed?'disabled':''}></td>
              <td><input type="time" value="${d.end||'24:00'}" ${d.closed?'disabled':''}></td>
              <td><input type="checkbox" ${d.closed?'checked':''}></td></tr>`;
          }).join('')}
        </tbody>`;
      wrap.innerHTML=''; wrap.appendChild(tbl);
      tbl.querySelectorAll('tbody tr').forEach(tr=>{
        const key=tr.dataset.k; const tInputs=tr.querySelectorAll('input[type=time]'); const chk=tr.querySelector('input[type=checkbox]');
        function syncDisabled(){ tInputs.forEach(inp=> inp.disabled = chk.checked); }
        tInputs[0].addEventListener('change', e=>{ openHours[key].start=e.target.value||'00:00'; save(); renderAll(); });
        tInputs[1].addEventListener('change', e=>{ openHours[key].end=e.target.value||'24:00'; save(); renderAll(); });
        chk.addEventListener('change', ()=>{ openHours[key].closed = chk.checked; syncDisabled(); save(); renderAll(); });
      });
    }

    // ===== Stats (simple) =====
    const elStatsWeek=document.getElementById('statsWeek');
    const elEmpSummaryTBody=document.querySelector('#empSummaryTbl tbody');
    const elAlertsSummary=document.getElementById('alertsSummary');
    const elAlertsList=document.getElementById('alertsList');
    const elHeatHead=document.getElementById('heatmapHead');
    const elHeatBody=document.getElementById('heatmapBody');
    const elHeatStart=document.getElementById('heatmapStartHour');

    function toMondayISO(weekValue){
      if(!weekValue) return weekStart; // fallback
      // weekValue like YYYY-W33
      const [y,w] = weekValue.split('-W').map(Number);
      const jan4 = new Date(Date.UTC(y,0,4));
      const day = jan4.getUTCDay()||7; // 1..7
      const monday = new Date(jan4); monday.setUTCDate(jan4.getUTCDate() - day + 1 + (w-1)*7);
      return monday.toISOString().slice(0,10);
    }

    function renderEmpSummary(){
      // in selected week
      const iso = elStatsWeek.value ? toMondayISO(elStatsWeek.value) : weekStart;
      const start = new Date(iso+'T00:00:00'); const end = addDays(start,7);
      const stats={};
      for(const s of shifts){ const d=new Date(s.dateISO+'T00:00:00'); if(d<start||d>=end) continue; (stats[s.employee]||(stats[s.employee]={hours:0,count:0,night:0,weekend:0,lates:0})); stats[s.employee].hours += hoursBetween(s.start,s.end); stats[s.employee].count++; }
      elEmpSummaryTBody.innerHTML='';
      Object.entries(stats).forEach(([name,v])=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${name}</td><td>${v.hours.toFixed(2)}</td><td>${v.count}</td><td>0</td><td>0</td><td>${v.lates}</td>`; elEmpSummaryTBody.appendChild(tr);
      });
      document.getElementById('kpiTotalShifts').textContent = Object.values(stats).reduce((a,b)=>a+b.count,0);
      const totH=Object.values(stats).reduce((a,b)=>a+b.hours,0); document.getElementById('kpiTotalHours').textContent = totH.toFixed(2);
      document.getElementById('kpiAvgShift').textContent = (totH ? (totH / (Object.values(stats).reduce((a,b)=>a+b.count,0)||1)).toFixed(2): '—');
    }

    function renderAlerts(){
      const start=new Date(weekStart+'T00:00:00'); const end=addDays(start,7);
      const items=[];
      for(const s of shifts){ const d=new Date(s.dateISO+'T00:00:00'); if(d<start||d>=end) continue; const dow=['sun','mon','tue','wed','thu','fri','sat'][d.getDay()]; const oh=getOpenCloseForDow(dow);
        if(!oh){ items.push({type:'closed', msg:`${s.dateISO} – ${s.employee} (${s.start}–${s.end}) zárt napon.`}); continue; }
        // outside open window?
        const sH=parseTime(s.start), eH=parseTime(s.end), oH=parseTime(oh.start), cH=parseTime(oh.end);
        function inOpen(x){ return cH>oH ? (x>=oH && x<=cH) : (x>=oH || x<=cH); }
        if(!inOpen(sH) || !inOpen((eH%24))){ items.push({type:'outside', msg:`${s.dateISO} – ${s.employee} műszak a nyitvatartáson kívül (${oh.start}–${oh.end}).`}); }
      }
      elAlertsList.innerHTML='';
      if(items.length===0){ elAlertsSummary.textContent='Nincs riasztás'; return; }
      elAlertsSummary.textContent = `${items.length} riasztás`;
      items.forEach(it=>{ const div=document.createElement('div'); div.className='alertItem'; div.textContent=it.msg; elAlertsList.appendChild(div); });
    }

    function renderHeatmap(){
      // populate start hour options once
      if(!elHeatStart.__init){ hoursOrder.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=pad(h)+":00"; elHeatStart.appendChild(o); }); elHeatStart.value=hoursOrder[0]; elHeatStart.__init=true; elHeatStart.addEventListener('change', renderHeatmap); }
      const startHour=parseInt(elHeatStart.value||hoursOrder[0],10);
      const order=[...Array(24).keys()].slice(startHour).concat([...Array(24).keys()].slice(0,startHour));
      elHeatHead.innerHTML = '<th>Nap</th>' + order.map(h=>`<th>${pad(h)}:00</th>`).join('');
      const start=new Date(weekStart+'T00:00:00'); const days=Array.from({length:7},(_,i)=>addDays(start,i));
      elHeatBody.innerHTML='';
      const headByDay={}; for(const d of days) headByDay[toISO(d)] = Array.from({length:24},()=>0);
      for(const s of shifts){ if(!headByDay[s.dateISO]) continue; for(let h=0;h<24;h++) if(overlapsHour(s.start,s.end,h)) headByDay[s.dateISO][h]++; }
      for(const d of days){ const iso=toISO(d); const dow=d.getDay(); const tr=document.createElement('tr'); const td0=document.createElement('td'); td0.textContent=iso; td0.className='left'; td0.style.fontWeight='600'; tr.appendChild(td0);
        for(const h of order){ const c=headByDay[iso][h]; const td=document.createElement('td'); td.textContent=c; if(inHighlight(h,dow)) td.className=(c===0?'c0':c===1?'c1':c===2?'c2':'c3'); tr.appendChild(td); }
        elHeatBody.appendChild(tr); }
    }

    function renderStatsAll(){ renderEmpSummary(); renderAlerts(); renderHeatmap(); }

    // ===== Admin =====
    const elAdminEmpTBody=document.querySelector('#adminEmpTable tbody');
    const elAdminRoleTableBody=document.querySelector('#adminRoleTable tbody');
    const elEmpEditBtn=document.getElementById('empEditBtn');
    const elEmpSaveBtn=document.getElementById('empSaveBtn');
    const elEmpCancelBtn=document.getElementById('empCancelBtn');
    const elRoleEditBtn=document.getElementById('roleEditBtn');
    const elRoleSaveBtn=document.getElementById('roleSaveBtn');
    const elRoleCancelBtn=document.getElementById('roleCancelBtn');

    let empEditMode=false, empSnapshot=null; let roleEditMode=false, roleSnapshot=null;

    function renderAdminEmpTable(){ elAdminEmpTBody.innerHTML=''; employees.forEach((e,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="text" value="${e.name||''}" data-idx="${idx}" data-field="name" ${empEditMode?'':'disabled'} style="width:100%"></td><td><input type="number" min="0" step="50" value="${e.wage==null?'':e.wage}" data-idx="${idx}" data-field="wage" ${empEditMode?'':'disabled'} style="width:120px"></td><td><button data-act="del" data-idx="${idx}" ${empEditMode?'':'disabled'}>Törlés</button></td>`; tr.querySelector('[data-act="del"]').addEventListener('click',ev=>{ const i=Number(ev.target.dataset.idx); employees.splice(i,1); save(); renderAdmin(); renderAll(); }); elAdminEmpTBody.appendChild(tr); }); }
    function renderAdminRoles(){ elAdminRoleTableBody.innerHTML=''; roles.forEach((r,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="text" value="${r}" data-idx="${idx}" ${roleEditMode?'':'disabled'} style="width:100%"></td><td><button data-act="del" data-idx="${idx}" ${roleEditMode?'':'disabled'}>Törlés</button></td>`; tr.querySelector('[data-act="del"]').addEventListener('click',ev=>{ const i=Number(ev.target.dataset.idx); roles.splice(i,1); save(); renderAdmin(); renderAll(); }); elAdminRoleTableBody.appendChild(tr); }); }
    function renderAdmin(){ renderAdminEmpTable(); renderAdminRoles(); elEmpEditBtn.classList.toggle('hidden', empEditMode); elEmpSaveBtn.classList.toggle('hidden', !empEditMode); elEmpCancelBtn.classList.toggle('hidden', !empEditMode); elRoleEditBtn.classList.toggle('hidden', roleEditMode); elRoleSaveBtn.classList.toggle('hidden', !roleEditMode); elRoleCancelBtn.classList.toggle('hidden', !roleEditMode); }

    document.getElementById('adminAddEmp').addEventListener('click', ()=>{ const name=(document.getElementById('adminNewEmp').value||'').trim(); const wageStr=(document.getElementById('adminWage').value||'').trim(); if(!name) return; const wage=wageStr===''?null:Number(wageStr); if(!employees.find(x=>x.name===name)) employees.push({name,wage}); document.getElementById('adminNewEmp').value=''; document.getElementById('adminWage').value=''; save(); renderAdmin(); renderAll(); });
    document.getElementById('adminAddRole').addEventListener('click', ()=>{ const r=(document.getElementById('adminNewRole').value||'').trim(); if(!r) return; if(!roles.includes(r)) roles.push(r); document.getElementById('adminNewRole').value=''; save(); renderAdmin(); renderAll(); });
    elEmpEditBtn.addEventListener('click', ()=>{ empSnapshot=JSON.parse(JSON.stringify(employees)); empEditMode=true; renderAdmin(); });
    elEmpCancelBtn.addEventListener('click', ()=>{ if(empSnapshot) employees=JSON.parse(JSON.stringify(empSnapshot)); empEditMode=false; renderAdmin(); renderAll(); save(); });
    elEmpSaveBtn.addEventListener('click', ()=>{ const rows=elAdminEmpTBody.querySelectorAll('tr'); rows.forEach((tr,i)=>{ const nameInp=tr.querySelector('input[data-field="name"]'); const wageInp=tr.querySelector('input[data-field="wage"]'); const name=(nameInp.value||'').trim(); const wageStr=(wageInp.value||'').trim(); employees[i].name=name; employees[i].wage=wageStr===''? null : Number(wageStr); }); empEditMode=false; save(); renderAdmin(); renderAll(); });
    elRoleEditBtn.addEventListener('click', ()=>{ roleSnapshot=JSON.parse(JSON.stringify(roles)); roleEditMode=true; renderAdmin(); });
    elRoleCancelBtn.addEventListener('click', ()=>{ if(roleSnapshot) roles=JSON.parse(JSON.stringify(roleSnapshot)); roleEditMode=false; save(); renderAdmin(); renderAll(); });
    elRoleSaveBtn.addEventListener('click', ()=>{ const rows=elAdminRoleTableBody.querySelectorAll('tr'); const newRoles=[]; rows.forEach(tr=>{ const val=(tr.querySelector('input').value||'').trim(); if(val) newRoles.push(val); }); roles=newRoles; roleEditMode=false; save(); renderAdmin(); renderAll(); });

    // ===== Render all =====
    function renderAll(){
      // Set default data for first-time
      if(employees.length===0){ employees.push({name:'Minta János', wage:null}); }
      elWeek.value=weekStart; elDate.value=weekStart;
      renderSelectors(); renderShiftTable(); renderHeadTable();
      renderOpenHoursInto('openHoursMain'); renderOpenHoursInto('openHoursStats');
      renderStatsAll();
    }

    // ===== Events (Main) =====
    document.getElementById('addRole').addEventListener('click', ()=>{ const r=(document.getElementById('newRole').value||'').trim(); if(!r) return; if(!roles.includes(r)) roles.push(r); document.getElementById('newRole').value=''; save(); renderAll(); });
    document.getElementById('addEmp').addEventListener('click', ()=>{ const name=(document.getElementById('newEmp').value||'').trim(); const wageStr=(document.getElementById('wage').value||'').trim(); if(!name) return; const wage=wageStr===''?null:Number(wageStr); if(!employees.find(e=>e.name===name)) employees.push({name,wage}); document.getElementById('newEmp').value=''; document.getElementById('wage').value=''; save(); renderAll(); });
    document.getElementById('addShift').addEventListener('click', ()=>{ const employee=elEmpSel.value, role=elRoleSel.value, dateISO=elDate.value, start=elStart.value, end=elEnd.value; if(!employee||!role||!dateISO||!start||!end) return; shifts.push({id:crypto.randomUUID(), employee, role, dateISO, start, end}); save(); renderAll(); });
    elWeek.addEventListener('change', ()=>{ if(!elWeek.value) return; weekStart = toISO(startOfWeekMon(new Date(elWeek.value+'T00:00:00'))); elWeek.value=weekStart; save(); renderAll(); });

    // ===== XLSX export (schedule sheet) =====
    document.getElementById('exportXlsxBtn').addEventListener('click', async ()=>{
      if(typeof ExcelJS==='undefined'){ alert('ExcelJS nem érhető el.'); return; }
      const HUN_DAYS=['Hétfő','Kedd','Szerda','Csütörtök','Péntek','Szombat','Vasárnap'];
      const IDX_TO_KEY={0:'mon',1:'tue',2:'wed',3:'thu',4:'fri',5:'sat',6:'sun'};
      const start=new Date(weekStart+'T00:00:00'); const days=Array.from({length:7},(_,i)=> addDays(start,i));
      const wb=new ExcelJS.Workbook(); const ws=wb.addWorksheet('Beosztás',{properties:{defaultRowHeight:18}});
      ws.columns=[{header:'',key:'name',width:28},...HUN_DAYS.map(()=>({width:14}))];
      const thin={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
      for(let i=0;i<7;i++){ const c=ws.getCell(1,2+i); c.value=HUN_DAYS[i]; c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFC2410C'}}; c.font={bold:true,color:{argb:'FFFFFFFF'}}; c.alignment={vertical:'middle',horizontal:'center'}; c.border=thin; }
      ws.getCell('A2').value='Nyitás'; ws.getCell('A2').fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF59E0B'}}; ws.getCell('A2').font={bold:true,color:{argb:'FFFFFFFF'}}; ws.getCell('A2').alignment={vertical:'middle',horizontal:'center'}; ws.getCell('A2').border=thin;
      for(let i=0;i<7;i++){ const key=IDX_TO_KEY[i]; const oh=openHours[key]; const cell=ws.getCell(2,2+i); cell.value = oh.closed? '—' : (oh.start||'00:00'); cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF59E0B'}}; cell.font={bold:true}; cell.alignment={vertical:'middle',horizontal:'center'}; cell.border=thin; }
      const startRow=3; employees.forEach((emp,idx)=>{ const rowIndex=startRow+idx; const nameCell=ws.getCell(rowIndex,1); nameCell.value=emp.name||''; nameCell.fill={type:'pattern',pattern:'solid',fgColor:{argb: idx%2? 'FF581C1C':'FF7F1D1D'}}; nameCell.font={bold:true,color:{argb:'FFFFFFFF'}}; nameCell.alignment={vertical:'middle',horizontal:'left'}; nameCell.border=thin; for(let d=0; d<7; d++){ const cell=ws.getCell(rowIndex,2+d); const iso=toISO(days[d]); const slots=(shifts||[]).filter(s=>s.dateISO===iso && s.employee===emp.name).map(s=>`${s.start}–${s.end}`); cell.value=slots.join(', '); cell.alignment={vertical:'middle',horizontal:'center'}; cell.fill={type:'pattern',pattern:'solid',fgColor:{argb: idx%2? 'FFD1D5DB':'FFE5E7EB'}}; cell.border=thin; } });
      const fname=`beosztas_${weekStart}.xlsx`; const buf=await wb.xlsx.writeBuffer(); const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // ===== Init =====
    load(); if(employees.length===0){ employees.push({name:'Minta János',wage:null}); save(); }
    weekStart = toISO(startOfWeekMon(new Date(weekStart+'T00:00:00'))); // force Monday
    // Initial renders
    renderAll();

    // Expose for debug/export blocks if needed
    window.__exportState = () => ({ employees, roles, shifts, weekStart, openHours });
  })();
  </script>
</body>
</html>
